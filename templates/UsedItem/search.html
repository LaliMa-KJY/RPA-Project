{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <title>중고거래 매물 검색</title>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="{% static 'search.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
    <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>

</head>
<body>
    <div class="wrapper">
        <div class="search">
            <div>
                <input
                    placeholder="물품명 또는 지역명을 검색해보세요"
                    value="{{ kw|default_if_none:'' }}"
                    id="kw_input"/>
                <i class="fa-solid fa-magnifying-glass" id="kw_search"></i>
            </div>
        </div>
        <div>
            <div class="option">
                <!-- <span>기본 | 낮은금액순 | 높은금액순</span> -->
                <button class="filter_btn" onclick="sortProducts('basic')">기본순</button>
                <hr class="filter_bar">
                <button class="filter_btn" onclick="sortProducts('low_price')">낮은금액순</button>
                <hr class="filter_bar">
                <button class="filter_btn" onclick="sortProducts('high_price')">높은금액순</button>
            </div>
            <div class="contents_wrapper">

        {#        {% if 당근 %}#}
                <div class="contents">
        {#                당근#}
                    <div class="img_wrapper">
                        <img class="logo" src="{% static 'images/danggeun_logo.png' %}" alt="Danggeun Market Logo">
                    </div>
                    <div class="container">
                        <div class="item_wrapper" id="danggeun">
                            <!-- item 리스트 영역 :: js로 채움 -->
                        </div>
                    </div>
                </div>
        {#        {% endif %}#}
        {#        {% if 번장 %}#}
                <div class="contents">
        {#                번장#}
                    <div class="img_wrapper">
                        <img class="logo" src="{% static 'images/bunjang_logo.png' %}" alt="Bunjang Logo">
                    </div>
                    <div class="container">
                        <div class="item_wrapper" id="bunjang">
                            <!-- item 리스트 영역 :: js로 채움 -->
                        </div>
                    </div>
                </div>
        {#        {% endif %}#}
        {#        {% if 중고나라 %}#}
                <div class="contents">
        {#                중고나라#}
                    <div class="img_wrapper">
                        <img class="logo" src="{% static 'images/joongna_logo.png' %}" alt="Joonggo Nara Logo">
                    </div>
                    <div class="container">
                        <div class="item_wrapper" id="joongna">
                            <!-- item 리스트 영역 :: js로 채움 -->
                        </div>
                    </div>
                </div>
        {#        {% endif %}#}
            </div>
            </div>

    </div>

    <form id="searchForm" method="get" action="{% url 'search' %}">
        <input type="hidden" id="kw" name="kw" value="{{ kw|default_if_none:'' }}"/>
    </form>

    {% block script %}
    <script type="text/javascript">
        
        
        // items 를 html로 렌더링
        function renderItems(items, flatform){
            console.log('페이지로드 - 렌더링')
            console.log(items)
            const itemWrapper = document.getElementById(flatform)
            itemWrapper.innerHTML = ''
            items.forEach(i => {
                const itemDiv = document.createElement('div')
                itemDiv.classList.add('item')
                itemDiv.innerHTML = `
                <div class="item_img_wrapper">
                            <img src="${i.img_url}" alt="${i.title}"/>
                        </div>
                        <div class="detail">
                            <div class="title">${i.title}</div>
                            <div class="price">${i.price}</div>
                            <div class="address">${i.location}</div>
                            </div>
                            `
                            // 클릭이벤트
                            itemDiv.addEventListener('click', () => {
                                console.log('click!');
                    console.log(i.url);
                    window.open(i.url, '_blank');
                });
                
                itemWrapper.appendChild(itemDiv)
            });
        }
        
        // 검색어 입력 이벤트 처리
        function doSearch(){
            console.log('검색어 입력됨 !!')
            console.log('kw값 >> '+$("#kw_input").val());
            $("#kw").val($("#kw_input").val());
            $("#searchForm").submit();
        }
        $("#kw_search").on('click', doSearch)
        $('#kw_input').on('keypress', function(event) { // 입력칸의 엔터키 이벤트
            if(event.which === 13) {
                doSearch();
            }
        })

        // search 일때만 검색 수행 및 아이템 출력
        // base 일때는 그냥 homepage 메인처럼 보이게
        console.log('{{ mode|escapejs }}')
        if('{{ mode|escapejs }}' == 'search'){
            // 서버에서 전달된 items 를 변수에 담기
            const items = JSON.parse('{{ items|escapejs }}')
            const bunjang = JSON.parse('{{ bunjang|escapejs }}')
            const danggeun = JSON.parse('{{ bunjang|escapejs }}')
            const joongna = JSON.parse('{{ bunjang|escapejs }}')
            // const danggeun = JSON.parse('{{ danggeun|escapejs }}')
            // const joongna = JSON.parse('{{ joongna|escapejs }}')
            console.log(items)
            
            // 페이지 로드시 아이템 리스트 렌더링
            renderItems(bunjang, 'bunjang')
            renderItems(danggeun, 'danggeun')
            renderItems(joongna, 'joongna')
        }

    </script>
    {% endblock %}
</body>
</html>
